<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nostalgic Spotify Tracks - Spencer Boggs</title>
    <link rel="icon" href="../icons/web_icon.png">
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Spotify-specific styles that integrate with existing site */
        .spotify-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .spotify-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .spotify-header h1 {
            font-size: 2.8rem;
            margin: 0;
            background: linear-gradient(90deg, #1db954, #1ed760);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: -0.05em;
        }

        .spotify-auth-form {
            max-width: 500px;
            margin: 0 auto;
            padding: 30px;
            background: linear-gradient(145deg, #121a2a, #0d1421);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .spotify-form-group {
            margin-bottom: 20px;
        }

        .spotify-form-group label {
            display: block;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95rem;
            font-weight: 500;
        }

        .spotify-form-group input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 6px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-sizing: border-box;
        }

        .spotify-form-group input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            border-color: #1db954;
            box-shadow: 0 0 0 2px rgba(29, 185, 84, 0.2);
        }

        .spotify-submit-btn {
            width: 100%;
            padding: 12px;
            background: #1db954;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .spotify-submit-btn:hover {
            background: #1ed760;
        }

        .spotify-loading {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.6);
        }

        .spotify-error {
            text-align: center;
            padding: 40px;
            color: #ff2d75;
        }

        .spotify-tracks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
        }

        .spotify-track {
            background: linear-gradient(145deg, #121a2a, #0d1421);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid rgba(255, 255, 255, 0.05);
            animation: fadeIn 0.3s ease forwards;
        }

        .spotify-track:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            border-color: rgba(29, 185, 84, 0.3);
        }

        .spotify-track-image {
            position: relative;
            width: 100%;
            padding-top: 100%;
            overflow: hidden;
        }

        .spotify-track-image img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .spotify-track:hover .spotify-track-image img {
            transform: scale(1.05);
        }

        .spotify-track-info {
            padding: 20px;
        }

        .spotify-track-title {
            font-size: 1.1rem;
            margin: 0 0 8px 0;
            color: white;
            font-weight: 600;
            letter-spacing: -0.02em;
            line-height: 1.3;
        }

        .spotify-track-artist {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            margin: 0 0 5px 0;
        }

        .spotify-track-album {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
            margin: 0 0 10px 0;
        }

        .spotify-track-popularity {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #1db954;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .spotify-popularity-bar {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .spotify-popularity-fill {
            height: 100%;
            background: linear-gradient(90deg, #1db954, #1ed760);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .spotify-controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 50px;
        }

        .spotify-controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .spotify-search-container {
            flex: 1;
            min-width: 250px;
            max-width: 500px;
        }

        .spotify-search {
            width: 100%;
            padding: 12px 20px;
            border-radius: 6px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-sizing: border-box;
        }

        .spotify-search:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            border-color: #1db954;
            box-shadow: 0 0 0 2px rgba(29, 185, 84, 0.2);
        }

        .spotify-search::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .spotify-sort-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .spotify-sort-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .spotify-sort-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .spotify-sort-btn.active {
            background: #1db954;
            color: white;
            font-weight: 600;
        }

        .spotify-no-results {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 1.1rem;
        }

        .spotify-switch-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .spotify-switch-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        @media (max-width: 768px) {
            .spotify-tracks-grid {
                grid-template-columns: 1fr;
            }
            
            .spotify-header h1 {
                font-size: 2.2rem;
            }
            
            .spotify-controls-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .spotify-search-container {
                width: 100%;
                max-width: 100%;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <section id="home"></section>
    <div class="top">
        <nav class="navbar">
            <ul class="nav-links">
                <a class="nav-button" href="../index.html#about">About</a>
                <a class="nav-button" href="../index.html#projects">Projects</a>
                <a class="nav-button" href="../index.html#contact">Contact</a>
                <div class="dropdown">
                    <a class="nav-button dropdown-toggle" href="#">More</a>
                    <div class="dropdown-content">
                        <a href="../gallery/photos.html">Photos</a>
                        <a href="steam-games.html">Steam Games</a>
                        <a href="spotify-tracks.html">Spotify Tracks</a>
                        <a href="../tools/internships.html">Internship Sorter</a>
                        <!-- <a href="../games/platformer.html">Platformer Game</a> -->
                        <!-- <a href="../games/tron-runner.html">Tron Runner</a> -->
                    </div>
                </div>
            </ul>
        </nav>
        <div class="profile-div">
            <div class="home">
                <h1 class="title" id="title">Nostalgic Spotify Tracks</h1>
                <p class="subtitle">Discover your older favorite songs from Spotify.</p>
            </div>
        </div>
    </div>
    <hr>

    <div class="spotify-container">
        <!-- Login Portal (shown initially) -->
        <div id="loginPortal" class="spotify-auth-form">
            <h2 style="text-align: center; margin-bottom: 30px; color: white;">Login with Spotify</h2>
            <p style="text-align: center; color: rgba(255, 255, 255, 0.7); margin-bottom: 30px;">
                Connect your Spotify account to discover your nostalgic tracks.
                <br><br>
                <strong>Note:</strong> Your data is processed locally and cleared when you close the page.
            </p>
            <div style="text-align: center;">
                <button onclick="loginWithSpotify()" class="spotify-submit-btn" style="width: 100%; padding: 15px; font-size: 1.1rem;">
                    🎵 Login with Spotify
                </button>
            </div>
            <div style="margin-top: 20px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 6px; font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">
                <strong>What you'll get:</strong><br>
                • Your top tracks from 6 months ago (nostalgic tracks)<br>
                • Beautiful album artwork and track info<br>
                • Search and sort functionality<br>
                • Real Spotify data from your account<br>
                <br>
                <strong>Note:</strong> You'll need to set up a Spotify app and add your Client ID to make this work.
            </div>
        </div>

        <!-- Controls (shown after auth) -->
        <div id="spotifyControls" class="spotify-controls" style="display: none;">
            <div style="text-align: center; margin-bottom: 20px;">
                <button onclick="clearStoredCredentials()" class="spotify-switch-btn">Switch Account</button>
            </div>
            <div class="spotify-controls-row">
                <div class="spotify-search-container">
                    <input type="text" class="spotify-search" placeholder="Search tracks..." id="searchInput">
                </div>
            </div>
            <div class="spotify-controls-row">
                <div class="spotify-sort-buttons">
                    <button class="spotify-sort-btn" data-sort="name" data-default-direction="asc">Name (A-Z)</button>
                    <button class="spotify-sort-btn" data-sort="artist" data-default-direction="asc">Artist</button>
                    <button class="spotify-sort-btn" data-sort="popularity" data-default-direction="desc">Popularity</button>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="spotify-loading" style="display: none;">
            <div style="width: 50px; height: 50px; border: 3px solid rgba(255, 255, 255, 0.1); border-top: 3px solid #1db954; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
            Loading your nostalgic tracks...
        </div>

        <!-- Error State -->
        <div id="errorState" class="spotify-error" style="display: none;">
            <h3>Error Loading Tracks</h3>
            <p id="errorMessage">Failed to load your Spotify tracks. Please check your credentials and try again.</p>
            <div style="margin-top: 20px;">
                <button onclick="showAuthForm()" class="spotify-submit-btn" style="width: auto; margin: 10px; padding: 10px 20px;">Try Again</button>
                <button onclick="showManualInput()" class="spotify-submit-btn" style="width: auto; margin: 10px; padding: 10px 20px; background: rgba(255, 255, 255, 0.1);">Manual Input</button>
            </div>
        </div>

        <!-- Manual Input Form -->
        <div id="manualInputForm" class="spotify-auth-form" style="display: none;">
            <h2 style="text-align: center; margin-bottom: 30px; color: white;">Manual Track Input</h2>
            <p style="text-align: center; color: rgba(255, 255, 255, 0.7); margin-bottom: 30px;">
                If the Spotify API is not working, you can manually add some of your favorite tracks.
            </p>
            <form id="manualTrackForm">
                <div class="spotify-form-group">
                    <label for="trackName">Track Name:</label>
                    <input type="text" id="trackName" placeholder="Enter track name" required>
                </div>
                <div class="spotify-form-group">
                    <label for="artistName">Artist:</label>
                    <input type="text" id="artistName" placeholder="Enter artist name" required>
                </div>
                <div class="spotify-form-group">
                    <label for="albumName">Album:</label>
                    <input type="text" id="albumName" placeholder="Enter album name">
                </div>
                <div class="spotify-form-group">
                    <label for="popularity">Popularity (0-100):</label>
                    <input type="number" id="popularity" placeholder="Enter popularity score" min="0" max="100" value="50">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="spotify-submit-btn" style="flex: 1;">Add Track</button>
                    <button type="button" onclick="showAuthForm()" class="spotify-submit-btn" style="flex: 1; background: rgba(255, 255, 255, 0.1);">Back to API</button>
                </div>
            </form>
            <div id="manualTracksList" style="margin-top: 30px;">
                <h3 style="color: white; margin-bottom: 15px;">Your Tracks:</h3>
                <div id="manualTracksContainer"></div>
                <button onclick="displayManualTracks()" class="spotify-submit-btn" style="width: 100%; margin-top: 20px;">View My Tracks</button>
            </div>
        </div>

        <!-- Tracks Grid -->
        <div id="tracksContainer" class="spotify-tracks-grid" style="display: none;">
            <!-- Tracks will be populated here -->
        </div>
    </div>

    <script>
        const SPOTIFY_CLIENT_ID = 'e7502cb4cb874dc0a07e82a8d2fc7952'; 
        const SPOTIFY_CLIENT_SECRET = 'b68730dff9c64018beffbd3045557a3c';
        const REDIRECT_URI = 'https://spencerboggs.github.io/spotify-tracks.html';
        const SCOPES = 'user-top-read';
        
        // Debug: Log the redirect URI being used
        console.log('Using redirect URI:', REDIRECT_URI);
        console.log('Current origin:', window.location.origin);
        
        let accessToken = '';
        let tracksData = [];
        let filteredTracks = [];

        // DOM elements
        const loginPortal = document.getElementById('loginPortal');
        const spotifyControls = document.getElementById('spotifyControls');
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const tracksContainer = document.getElementById('tracksContainer');
        const manualInputForm = document.getElementById('manualInputForm');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize dropdown functionality
            const dropdowns = document.querySelectorAll('.dropdown');
            dropdowns.forEach(dropdown => {
                const toggle = dropdown.querySelector('.dropdown-toggle');
                const content = dropdown.querySelector('.dropdown-content');
                
                if (toggle && content) {
                    toggle.addEventListener('click', function(e) {
                        e.preventDefault();
                        content.style.display = content.style.display === 'block' ? 'none' : 'block';
                    });
                    
                    // Close dropdown when clicking outside
                    document.addEventListener('click', function(e) {
                        if (!dropdown.contains(e.target)) {
                            content.style.display = 'none';
                        }
                    });
                }
            });
            
            // Check for access token in URL (OAuth callback)
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (error) {
                showError('Spotify authentication was cancelled or failed. Please try again.');
                return;
            }
            
            if (code) {
                // We're in the OAuth callback, exchange code for token
                exchangeCodeForToken(code);
                return;
            }
            
            // Check if we have a stored access token
            const storedToken = sessionStorage.getItem('spotifyAccessToken');
            if (storedToken) {
                accessToken = storedToken;
                loadTracks();
            }

            // Search functionality
            document.getElementById('searchInput').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filterTracks(searchTerm);
            });

            // Sort functionality
            document.querySelectorAll('.spotify-sort-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const sortType = this.dataset.sort;
                    const direction = this.dataset.defaultDirection || 'asc';
                    sortTracks(sortType, direction);
                    
                    // Update active button
                    document.querySelectorAll('.spotify-sort-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Manual track form
            document.getElementById('manualTrackForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const trackName = document.getElementById('trackName').value;
                const artistName = document.getElementById('artistName').value;
                const albumName = document.getElementById('albumName').value;
                const popularity = parseInt(document.getElementById('popularity').value) || 50;
                
                const track = {
                    song: trackName,
                    artist: artistName,
                    album: albumName,
                    popularity: popularity,
                    image: 'https://via.placeholder.com/300x300/1db954/ffffff?text=♪',
                    id: Date.now()
                };
                
                manualTracks.push(track);
                localStorage.setItem('manualTracks', JSON.stringify(manualTracks));
                
                // Clear form
                document.getElementById('trackName').value = '';
                document.getElementById('artistName').value = '';
                document.getElementById('albumName').value = '';
                document.getElementById('popularity').value = '50';
                
                updateManualTracksList();
            });
        });

        function loginWithSpotify() {
            // Generate a random state parameter for security
            const state = Math.random().toString(36).substring(2, 15);
            sessionStorage.setItem('spotifyState', state);
            
            // Build the authorization URL
            const authUrl = `https://accounts.spotify.com/authorize?` +
                `client_id=${SPOTIFY_CLIENT_ID}&` +
                `response_type=code&` +
                `redirect_uri=${encodeURIComponent(REDIRECT_URI)}&` +
                `scope=${encodeURIComponent(SCOPES)}&` +
                `state=${state}`;
            
            // Debug: Log the full auth URL
            console.log('=== SPOTIFY OAUTH DEBUG ===');
            console.log('Client ID:', SPOTIFY_CLIENT_ID);
            console.log('Redirect URI (raw):', REDIRECT_URI);
            console.log('Redirect URI (encoded):', encodeURIComponent(REDIRECT_URI));
            console.log('Full Auth URL:', authUrl);
            console.log('Current URL:', window.location.href);
            console.log('Current Origin:', window.location.origin);
            console.log('========================');
            
            // Show alert with the redirect URI for easy copying
            alert(`Copy this EXACT redirect URI to your Spotify app settings:\n\n${REDIRECT_URI}\n\nCurrent page URL: ${window.location.href}\n\nIf you have HTML removal code, try both:\n- With .html: http://localhost:8000/spotify-tracks.html\n- Without .html: http://localhost:8000/spotify-tracks`);
            
            // Redirect to Spotify authorization
            window.location.href = authUrl;
        }

        async function exchangeCodeForToken(code) {
            showLoading();
            
            try {
                // Exchange authorization code for access token
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': 'Basic ' + btoa(SPOTIFY_CLIENT_ID + ':' + SPOTIFY_CLIENT_SECRET)
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: REDIRECT_URI
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to exchange code for token');
                }
                
                const data = await response.json();
                accessToken = data.access_token;
                
                // Store token in session storage
                sessionStorage.setItem('spotifyAccessToken', accessToken);
                
                // Load user's tracks
                await loadTracks();
                
            } catch (error) {
                console.error('Error exchanging code for token:', error);
                showError('Failed to complete Spotify authentication. Please try again.');
            }
        }

        async function loadTracks() {
            showLoading();
            
            try {
                // Get older tracks (similar to your original app's get_older_top_tracks function)
                const olderTracks = await getOlderTopTracks();
                
                if (olderTracks && olderTracks.length > 0) {
                    tracksData = olderTracks;
                    filteredTracks = olderTracks;
                    displayTracks();
                } else {
                    showError('No nostalgic tracks found. You might need more listening history or try the manual input option.');
                }
            } catch (error) {
                console.error('Error loading tracks:', error);
                showError('Failed to load tracks. Please try the manual input option.');
            }
        }

        async function getOlderTopTracks() {
            try {
                // Get medium-term tracks (last 6 months)
                const mediumTermTracks = await getTopTracks('medium_term', 50);
                if (!mediumTermTracks) return null;

                // Get long-term tracks (all time)
                const longTermTracks = await getTopTracks('long_term', 50);
                if (!longTermTracks) return null;

                // Find tracks that are in long-term but not in medium-term (older tracks)
                const mediumTermSongNames = new Set(mediumTermTracks.map(track => track.song));
                const olderTracks = longTermTracks.filter(track => 
                    !mediumTermSongNames.has(track.song)
                );

                return olderTracks;
            } catch (error) {
                console.error('Error getting older tracks:', error);
                return null;
            }
        }

        async function getTopTracks(timeRange, limit) {
            try {
                const response = await fetch(`https://api.spotify.com/v1/me/top/tracks?limit=${limit}&time_range=${timeRange}`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.status === 401) {
                    // Token expired, try to refresh
                    await refreshAccessToken();
                    const newResponse = await fetch(`https://api.spotify.com/v1/me/top/tracks?limit=${limit}&time_range=${timeRange}`, {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });
                    
                    if (!newResponse.ok) {
                        throw new Error('Failed to fetch tracks after token refresh');
                    }
                    
                    const data = await newResponse.json();
                    return data.items.map(item => ({
                        song: item.name,
                        artist: item.artists[0].name,
                        album: item.album.name,
                        popularity: item.popularity,
                        image: item.album.images[0]?.url || 'https://via.placeholder.com/300x300/1db954/ffffff?text=♪'
                    }));
                }

                if (!response.ok) {
                    throw new Error('Failed to fetch tracks');
                }

                const data = await response.json();
                return data.items.map(item => ({
                    song: item.name,
                    artist: item.artists[0].name,
                    album: item.album.name,
                    popularity: item.popularity,
                    image: item.album.images[0]?.url || 'https://via.placeholder.com/300x300/1db954/ffffff?text=♪'
                }));
            } catch (error) {
                console.error('Error fetching top tracks:', error);
                return null;
            }
        }

        async function refreshAccessToken() {
            // For now, we'll just clear the token and ask user to re-authenticate
            // In a full implementation, you'd use the refresh token
            sessionStorage.removeItem('spotifyAccessToken');
            accessToken = '';
            throw new Error('Token expired. Please re-authenticate.');
        }

        function displayTracks() {
            authForm.style.display = 'none';
            spotifyControls.style.display = 'block';
            tracksContainer.style.display = 'grid';
            loadingState.style.display = 'none';
            errorState.style.display = 'none';
            manualInputForm.style.display = 'none';

            tracksContainer.innerHTML = '';
            
            filteredTracks.forEach(track => {
                const trackElement = createTrackElement(track);
                tracksContainer.appendChild(trackElement);
            });

            // Set default sort
            document.querySelector('.spotify-sort-btn[data-sort="name"]').classList.add('active');
        }

        function createTrackElement(track) {
            const trackDiv = document.createElement('div');
            trackDiv.className = 'spotify-track';
            trackDiv.setAttribute('data-name', track.song.toLowerCase());
            trackDiv.setAttribute('data-artist', track.artist.toLowerCase());
            trackDiv.setAttribute('data-popularity', track.popularity);

            trackDiv.innerHTML = `
                <div class="spotify-track-image">
                    <img src="${track.image}" alt="${track.album}" onerror="this.src='https://via.placeholder.com/300x300/1db954/ffffff?text=♪'">
                </div>
                <div class="spotify-track-info">
                    <h3 class="spotify-track-title">${track.song}</h3>
                    <p class="spotify-track-artist">${track.artist}</p>
                    <p class="spotify-track-album">${track.album}</p>
                    <div class="spotify-track-popularity">
                        <span>Popularity: ${track.popularity}%</span>
                        <div class="spotify-popularity-bar">
                            <div class="spotify-popularity-fill" style="width: ${track.popularity}%"></div>
                        </div>
                    </div>
                </div>
            `;

            return trackDiv;
        }

        function filterTracks(searchTerm) {
            const tracks = document.querySelectorAll('.spotify-track');
            let visibleCount = 0;

            tracks.forEach(track => {
                const trackName = track.getAttribute('data-name');
                const artistName = track.getAttribute('data-artist');
                if (trackName.includes(searchTerm) || artistName.includes(searchTerm)) {
                    track.style.display = '';
                    visibleCount++;
                } else {
                    track.style.display = 'none';
                }
            });

            // Show/hide no results message
            let noResults = document.querySelector('.spotify-no-results');
            if (visibleCount === 0 && searchTerm) {
                if (!noResults) {
                    noResults = document.createElement('div');
                    noResults.className = 'spotify-no-results';
                    noResults.textContent = 'No tracks found matching your search';
                    tracksContainer.appendChild(noResults);
                }
            } else if (noResults) {
                noResults.remove();
            }
        }

        function sortTracks(sortType, direction) {
            const tracks = Array.from(document.querySelectorAll('.spotify-track'));
            
            tracks.sort((a, b) => {
                let valueA, valueB;

                switch (sortType) {
                    case 'name':
                        valueA = a.getAttribute('data-name');
                        valueB = b.getAttribute('data-name');
                        return direction === 'asc' ? 
                            valueA.localeCompare(valueB) : 
                            valueB.localeCompare(valueA);

                    case 'artist':
                        valueA = a.getAttribute('data-artist');
                        valueB = b.getAttribute('data-artist');
                        return direction === 'asc' ? 
                            valueA.localeCompare(valueB) : 
                            valueB.localeCompare(valueA);

                    case 'popularity':
                        valueA = parseInt(a.getAttribute('data-popularity')) || 0;
                        valueB = parseInt(b.getAttribute('data-popularity')) || 0;
                        break;

                    default:
                        return 0;
                }

                return direction === 'asc' ? valueA - valueB : valueB - valueA;
            });

            tracks.forEach(track => tracksContainer.appendChild(track));
        }

        function showLoading() {
            loginPortal.style.display = 'none';
            spotifyControls.style.display = 'none';
            tracksContainer.style.display = 'none';
            loadingState.style.display = 'block';
            errorState.style.display = 'none';
            manualInputForm.style.display = 'none';
        }

        function showError(message) {
            loginPortal.style.display = 'none';
            spotifyControls.style.display = 'none';
            tracksContainer.style.display = 'none';
            loadingState.style.display = 'none';
            errorState.style.display = 'block';
            manualInputForm.style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
        }

        function showLoginPortal() {
            loginPortal.style.display = 'block';
            spotifyControls.style.display = 'none';
            tracksContainer.style.display = 'none';
            loadingState.style.display = 'none';
            errorState.style.display = 'none';
            manualInputForm.style.display = 'none';
        }

        function showManualInput() {
            loginPortal.style.display = 'none';
            spotifyControls.style.display = 'none';
            tracksContainer.style.display = 'none';
            loadingState.style.display = 'none';
            errorState.style.display = 'none';
            manualInputForm.style.display = 'block';
        }

        function clearStoredCredentials() {
            // Clear stored credentials and tokens
            sessionStorage.removeItem('spotifyAccessToken');
            sessionStorage.removeItem('spotifyState');
            localStorage.removeItem('manualTracks');
            
            // Clear current values
            accessToken = '';
            tracksData = [];
            filteredTracks = [];
            
            // Show login portal
            showLoginPortal();
        }

        // Clear data when page is closed/refreshed
        window.addEventListener('beforeunload', function() {
            sessionStorage.removeItem('spotifyAccessToken');
            sessionStorage.removeItem('spotifyState');
        });

        // Manual track management
        let manualTracks = JSON.parse(localStorage.getItem('manualTracks') || '[]');

        function updateManualTracksList() {
            const container = document.getElementById('manualTracksContainer');
            container.innerHTML = '';
            
            manualTracks.forEach((track, index) => {
                const trackDiv = document.createElement('div');
                trackDiv.style.cssText = 'background: rgba(255, 255, 255, 0.05); padding: 10px; margin: 5px 0; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;';
                trackDiv.innerHTML = `
                    <span>${track.song} - ${track.artist} (${track.popularity}%)</span>
                    <button onclick="removeManualTrack(${index})" style="background: #ff2d75; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Remove</button>
                `;
                container.appendChild(trackDiv);
            });
        }

        function removeManualTrack(index) {
            manualTracks.splice(index, 1);
            localStorage.setItem('manualTracks', JSON.stringify(manualTracks));
            updateManualTracksList();
        }

        function displayManualTracks() {
            if (manualTracks.length === 0) {
                alert('Please add some tracks first!');
                return;
            }
            
            tracksData = manualTracks;
            filteredTracks = manualTracks;
            displayTracks();
        }

        // Add spin animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
